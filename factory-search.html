<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>factory-search</title>
<script src="jquery.js"></script>
<script src="factory.js"></script>
<script src="damage.js"></script>
<script>
$(function () {
	initialize_factory(function () {
		var ng_items = ["きあいのハチマキ", "せんせいのツメ", "きあいのタスキ", "ひかりのこな", "のんきのおこう"];
		var ng_abilities = ["ゆうばく", "ほのおのからだ", "ほうし", "トレース", "いかく"]
		var ng_abilities2 = ["ゆうばく"];
		// ムクホかラティ
		var mukuho = gen_poke(RANK_OPEN_8, true, factory_data[789], 0);
		var rathi = gen_poke(RANK_OPEN_8, true, factory_data[933], 0);
		var rai = gen_poke(RANK_OPEN_8, true, factory_data[788], 0);
		var brave = waza_fromname[mukuho.entry.move[0]];
		var ngs = [], num = 0;
		for (var i = 623; i <= 950; i ++) {
			var ret1 = check_1turn_ko(mukuho, i, null, ng_items, ng_abilities);
			var ret2 = check_1turn_ko(rathi, i, null, ng_items, ng_abilities2);
			if (ret1 == "skipped" || ret2 == "skipped") continue;
			var ok = ret1 || ret2;
			if (!ok) ngs.push(i);
			num ++;
		}
		console.log(ngs.length+" / "+num);
	});
});

function check_1turn_ko(my, entryid, fixedWaza, ng_items, ng_abilities) {
	var target = gen_poke(RANK_OPEN_8, true, factory_data[entryid], 0);
	if (target.item == my.item || target.name == my.name) {
		return "skipped";
	}
	var dmg = 0;
	if (fixedWaza) {
		dmg = damage(my, fixedWaza, entryid);
	} else {
		my.entry.move.forEach (function (waza) {
			dmg = Math.max(dmg, damage(my, waza_fromname[waza], entryid));
		});
	}
	var damageOk = dmg >= target.hp;

	var speedOk = calcComputedSpeed(target) < calcComputedSpeed(my);
	var itemOk = ng_items.indexOf(target.item) < 0;
	var badAbility = target.entry.pokemon.abilities.filter(function(x) { return ng_abilities.indexOf(x) >= 0 });
	var abilityOk = badAbility.length == 0;
	var ok = speedOk && damageOk && itemOk && abilityOk;

	var msg = target.name+":";
	msg += (speedOk ? "" : " speedNG("+calcComputedSpeed(target)+")");
	msg += (damageOk ? "" : " damageNG("+dmg+" / "+target.hp+")");
	msg += (itemOk ? "" : " itemNG("+target.item+")");
	msg += (abilityOk ? "" : " abilityNG("+badAbility.join(",")+")");
	msg += (ok ? " OK" : "");

	return ok;
}

function damage(userPoke, waza, index) {
	// 2つの特性両方を試す
	var target = gen_poke(RANK_OPEN_8, true, factory_data[index], 0);
	var dmg1 = calcDamage(userPoke, target, waza);
	var target = gen_poke(RANK_OPEN_8, true, factory_data[index], 1);
	var dmg2 = calcDamage(userPoke, target, waza);
	return Math.min(dmg1, dmg2);
}

</script>
</head>
<body>
</body>
</html>
